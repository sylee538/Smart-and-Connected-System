# Code Readme
Authors: Rene Colato, Edward Hong, SeungYeun Lee
2019-11-22

# Main Components Directory
**FOB Code:** /FOB/main/**uart_async_rxtxtasks_main**
**HUB Code:** /HUB/main/**uart_async_rxtxtasks_main**
**Front End Code:** /Node/**index.js**
                    /Node/**index.html**

# Implementation
## **FOB CODE**

### tx_task():
This task transmits the FOB ID & its corresponding code, it concatenates the code into a proper payload and sends it through the IR. The message is looped continuously to ensure something was received, it will not stop until a signal is received from the server.

### udp_client_task():
This task initiates a UDP server and listens for any messages. It listens for any data sent to the ESP's IP and determines if the device is clear to enter.

### rmt_tx_int():
This function generates an oscillating square wave at the frequency of 38,000 Hz. This is so the IR sensor can pick up the signal.

### control():
This task controls the state of the device, a pseudo-state machine is implemented so this task determines which state the device should be in. This task also takes a GPIO input from the on-board button and some logic is implemented to detect only the rising edge of the button. Clicking the button toggles the **FOB ID**. Toggling between **FOB ID's** simulate multiple fobs from multiple users, since we did not have enough functioning ESPs to reach the required 3 fobs.

### app_main():
Initiates all tasks and controls display LED, depending on the state of the FOB, different light gets turned on to tell the user the device's current state.

## **HUB CODE**
### rx_task():
This task receives the IR signal from the IR receiver and reads it into *uint8_t*, which then gets converted into a string to be parsed. The parser looks for the 1st & 2nd word, which is saved in global variables **code** and the **FOB ID** of the device.

### udp_client_task():
Initiates a UDP socket with the Node server and sends a concatenated string of (Fob ID, Hub ID, Code) to the address of the Node host.

### control():
Much like the FOB, the HUB also runs on a state machine and the logic of state transitions happen here. This task also takes a GPIO input from the on-board button and some logic is implemented to detect only the rising edge of the button. Clicking the button toggles the **HUB ID**, which like the FOB unit simulates multiple hubs to show the database querying by location if necessary.

### app_main():
Initiates all tasks and controls display LED, depending on the state of the FOB, different light gets turned on to tell the user the device's current state.

## **NODE SERVER CODE**
## Node Q3
*All packages are in node_modules*
### index.js
The basis of this node server uses dgram, and it listens to the ESP32 for data and sends information that will get parsed by "udp_client_task()" to start or stop the rover.
The data is generated by a front-end html webpage, with a start and stop button. Clicking the buttons will trigger an emit event through socket to the node server and back to the rover.

The basis of this node server uses dgram, and it listens to the HUB ESP32 the **FOB ID**, **HUB ID**, and **CODE**. The server then queries the TingoDB based database to verify the credentials and, if valid, logs the presence of the user granting them access. Finally, the server pushes the data to a persistent list of log-ins/log-outs onto the HTML

### index.html
Basic HTML with two buttons, one labelled "Run" and one labelled "Stop". Clicking both buttons triggers a socket emit event.

Basic HTML with four buttons, three buttons (**Rene Lock**, **Kelly Lock**, **Eddie Lock**) are intended to be used via sockets to lock users. The final button **Run** triggers a socket emit event to debug (our socket implementation is not operational).
